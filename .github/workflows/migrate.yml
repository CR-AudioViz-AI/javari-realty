name: Database Migration

on:
  workflow_dispatch:
    inputs:
      action:
        description: Type MIGRATE to confirm
        required: true

jobs:
  migrate:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'MIGRATE'
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install pg
        run: npm install pg
        
      - name: Run Migration via Pooler
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          echo "Password length: ${#PGPASSWORD}"
          echo "Password first 3: ${PGPASSWORD:0:3}"
          
          # Use pooler IPv4 directly
          POOLER_IP="44.216.29.125"
          echo "Using pooler IP: $POOLER_IP"
          
          export DB_HOST=$POOLER_IP
          export DB_PORT=6543
          export DB_USER="postgres.kteobfyferrukqeolofj"
          
          node -e "
          const { Client } = require('pg');
          
          console.log('DB_HOST:', process.env.DB_HOST);
          console.log('DB_USER:', process.env.DB_USER);
          console.log('Password length:', process.env.PGPASSWORD ? process.env.PGPASSWORD.length : 0);
          
          const client = new Client({
            host: process.env.DB_HOST,
            port: parseInt(process.env.DB_PORT),
            user: process.env.DB_USER,
            password: process.env.PGPASSWORD,
            database: 'postgres',
            ssl: { rejectUnauthorized: false }
          });

          async function run() {
            console.log('Connecting to Supabase pooler...');
            await client.connect();
            console.log('Connected!');
            
            // Quick test
            const ver = await client.query('SELECT version()');
            console.log('PostgreSQL:', ver.rows[0].version.substring(0, 50));
            
            console.log('Running migration...');
            
            // Create tables one by one
            await client.query(\\\`CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\"\\\`);
            console.log('  - Extension created');
            
            await client.query(\\\`CREATE TABLE IF NOT EXISTS profiles (id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE, email TEXT UNIQUE NOT NULL, full_name TEXT, phone TEXT, role TEXT DEFAULT 'client', avatar_url TEXT, license_number TEXT, license_state TEXT, brokerage TEXT, bio TEXT, specialties TEXT[], service_areas TEXT[], years_experience INTEGER, is_admin BOOLEAN DEFAULT false, is_active BOOLEAN DEFAULT true, created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW())\\\`);
            console.log('  - profiles table');
            
            await client.query(\\\`CREATE TABLE IF NOT EXISTS properties (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), agent_id UUID REFERENCES profiles(id), mls_id TEXT, title TEXT NOT NULL, description TEXT, property_type TEXT DEFAULT 'single_family', status TEXT DEFAULT 'active', address TEXT NOT NULL, city TEXT NOT NULL, state TEXT NOT NULL, zip_code TEXT NOT NULL, county TEXT, latitude NUMERIC(10, 7), longitude NUMERIC(10, 7), price NUMERIC(12, 2) NOT NULL, bedrooms INTEGER, bathrooms NUMERIC(3, 1), sqft INTEGER, lot_size NUMERIC(10, 2), year_built INTEGER, features TEXT[], photos TEXT[], primary_image_url TEXT, virtual_tour_url TEXT, is_featured BOOLEAN DEFAULT false, listed_date DATE, sold_date DATE, sold_price NUMERIC(12, 2), created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW())\\\`);
            console.log('  - properties table');
            
            await client.query(\\\`CREATE TABLE IF NOT EXISTS realtor_customers (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), auth_user_id UUID REFERENCES auth.users(id), agent_id UUID REFERENCES profiles(id), email TEXT NOT NULL, full_name TEXT NOT NULL, phone TEXT, preferred_contact TEXT DEFAULT 'email', budget_min NUMERIC(12, 2), budget_max NUMERIC(12, 2), preferred_locations TEXT[], property_types TEXT[], notes TEXT, status TEXT DEFAULT 'active', source TEXT, created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW())\\\`);
            console.log('  - realtor_customers table');
            
            await client.query(\\\`CREATE TABLE IF NOT EXISTS realtor_leads (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), agent_id UUID REFERENCES profiles(id), first_name TEXT, last_name TEXT, email TEXT, phone TEXT, status TEXT DEFAULT 'new', source TEXT, budget_min NUMERIC(12, 2), budget_max NUMERIC(12, 2), preferred_locations TEXT[], property_type TEXT, notes TEXT, last_contact_date TIMESTAMPTZ, next_followup_date TIMESTAMPTZ, created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW())\\\`);
            console.log('  - realtor_leads table');
            
            await client.query(\\\`CREATE TABLE IF NOT EXISTS saved_properties (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE, property_id UUID REFERENCES properties(id) ON DELETE CASCADE, notes TEXT, rating INTEGER, created_at TIMESTAMPTZ DEFAULT NOW(), UNIQUE(user_id, property_id))\\\`);
            console.log('  - saved_properties table');
            
            await client.query(\\\`CREATE TABLE IF NOT EXISTS showings (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), property_id UUID REFERENCES properties(id), agent_id UUID REFERENCES profiles(id), customer_id UUID REFERENCES realtor_customers(id), scheduled_at TIMESTAMPTZ NOT NULL, duration_minutes INTEGER DEFAULT 30, status TEXT DEFAULT 'pending', notes TEXT, feedback TEXT, created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW())\\\`);
            console.log('  - showings table');
            
            await client.query(\\\`CREATE TABLE IF NOT EXISTS vendors (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), agent_id UUID NOT NULL REFERENCES profiles(id), business_name TEXT NOT NULL, contact_name TEXT, email TEXT, phone TEXT, website TEXT, city TEXT, state TEXT, category TEXT NOT NULL, description TEXT, notes TEXT, is_preferred BOOLEAN DEFAULT false, is_active BOOLEAN DEFAULT true, created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW())\\\`);
            console.log('  - vendors table');
            
            await client.query(\\\`CREATE TABLE IF NOT EXISTS organizations (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), name TEXT NOT NULL, slug TEXT UNIQUE, logo_url TEXT, contact_email TEXT, contact_phone TEXT, address TEXT, city TEXT, state TEXT, zip TEXT, website TEXT, is_active BOOLEAN DEFAULT true, created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW())\\\`);
            console.log('  - organizations table');
            
            await client.query(\\\`CREATE TABLE IF NOT EXISTS realtor_messages (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), conversation_id UUID, sender_id UUID REFERENCES auth.users(id), recipient_id UUID REFERENCES auth.users(id), property_id UUID REFERENCES properties(id), subject TEXT, content TEXT NOT NULL, is_read BOOLEAN DEFAULT false, created_at TIMESTAMPTZ DEFAULT NOW())\\\`);
            console.log('  - realtor_messages table');
            
            console.log('All tables created!');
            
            // Enable RLS
            const tables = ['profiles', 'properties', 'realtor_customers', 'realtor_leads', 'saved_properties', 'showings', 'vendors', 'organizations', 'realtor_messages'];
            for (const t of tables) {
              await client.query(\\\`ALTER TABLE \\\${t} ENABLE ROW LEVEL SECURITY\\\`);
            }
            console.log('RLS enabled');
            
            // Seed profiles
            await client.query(\\\`INSERT INTO profiles (id, email, full_name, role) SELECT id, email, COALESCE(raw_user_meta_data->>'full_name', ''), CASE WHEN email LIKE '%tony%' OR email LIKE '%laura%' THEN 'realtor' ELSE 'client' END FROM auth.users ON CONFLICT (id) DO UPDATE SET role = CASE WHEN EXCLUDED.email LIKE '%tony%' OR EXCLUDED.email LIKE '%laura%' THEN 'realtor' ELSE profiles.role END\\\`);
            
            // Verify
            const result = await client.query(\\\"SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('profiles', 'properties', 'realtor_customers', 'realtor_leads', 'saved_properties', 'showings', 'vendors', 'organizations', 'realtor_messages') ORDER BY table_name\\\");
            console.log('Tables created:', result.rows.map(r => r.table_name).join(', '));
            
            const profiles = await client.query('SELECT COUNT(*) as cnt FROM profiles');
            console.log('Profiles seeded:', profiles.rows[0].cnt);
            
            await client.end();
            console.log('\\nMIGRATION COMPLETE!');
          }
          
          run().catch(e => { console.error('Error:', e.message); console.error(e.stack); process.exit(1); });
          "
