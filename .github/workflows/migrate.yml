name: Run Database Migration

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "migrate" to confirm'
        required: true
        default: ''

jobs:
  migrate:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'migrate'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          
      - name: Run Migration
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          psql "postgresql://postgres:$PGPASSWORD@db.kteobfyferrukqeolofj.supabase.co:5432/postgres" << 'ENDSQL'
          
          -- CR REALTOR PLATFORM MIGRATION
          CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

          CREATE TABLE IF NOT EXISTS profiles (
              id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
              email TEXT UNIQUE NOT NULL, full_name TEXT, phone TEXT, role TEXT DEFAULT 'client',
              avatar_url TEXT, license_number TEXT, license_state TEXT, brokerage TEXT, bio TEXT,
              specialties TEXT[], service_areas TEXT[], years_experience INTEGER,
              is_admin BOOLEAN DEFAULT false, is_active BOOLEAN DEFAULT true,
              created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()
          );

          CREATE TABLE IF NOT EXISTS properties (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(), agent_id UUID REFERENCES profiles(id),
              mls_id TEXT, title TEXT NOT NULL, description TEXT, property_type TEXT DEFAULT 'single_family',
              status TEXT DEFAULT 'active', address TEXT NOT NULL, city TEXT NOT NULL, state TEXT NOT NULL,
              zip_code TEXT NOT NULL, county TEXT, latitude NUMERIC(10, 7), longitude NUMERIC(10, 7),
              price NUMERIC(12, 2) NOT NULL, bedrooms INTEGER, bathrooms NUMERIC(3, 1), sqft INTEGER,
              lot_size NUMERIC(10, 2), year_built INTEGER, features TEXT[], photos TEXT[],
              primary_image_url TEXT, virtual_tour_url TEXT, is_featured BOOLEAN DEFAULT false,
              listed_date DATE, sold_date DATE, sold_price NUMERIC(12, 2),
              created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()
          );

          CREATE TABLE IF NOT EXISTS realtor_customers (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(), auth_user_id UUID REFERENCES auth.users(id),
              agent_id UUID REFERENCES profiles(id), email TEXT NOT NULL, full_name TEXT NOT NULL,
              phone TEXT, preferred_contact TEXT DEFAULT 'email', budget_min NUMERIC(12, 2),
              budget_max NUMERIC(12, 2), preferred_locations TEXT[], property_types TEXT[],
              notes TEXT, status TEXT DEFAULT 'active', source TEXT,
              created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()
          );

          CREATE TABLE IF NOT EXISTS realtor_leads (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(), agent_id UUID REFERENCES profiles(id),
              first_name TEXT, last_name TEXT, email TEXT, phone TEXT, status TEXT DEFAULT 'new',
              source TEXT, budget_min NUMERIC(12, 2), budget_max NUMERIC(12, 2),
              preferred_locations TEXT[], property_type TEXT, notes TEXT,
              last_contact_date TIMESTAMPTZ, next_followup_date TIMESTAMPTZ,
              created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()
          );

          CREATE TABLE IF NOT EXISTS saved_properties (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
              user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
              property_id UUID REFERENCES properties(id) ON DELETE CASCADE,
              notes TEXT, rating INTEGER, created_at TIMESTAMPTZ DEFAULT NOW(),
              UNIQUE(user_id, property_id)
          );

          CREATE TABLE IF NOT EXISTS showings (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(), property_id UUID REFERENCES properties(id),
              agent_id UUID REFERENCES profiles(id), customer_id UUID REFERENCES realtor_customers(id),
              scheduled_at TIMESTAMPTZ NOT NULL, duration_minutes INTEGER DEFAULT 30,
              status TEXT DEFAULT 'pending', notes TEXT, feedback TEXT,
              created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()
          );

          CREATE TABLE IF NOT EXISTS vendors (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(), agent_id UUID NOT NULL REFERENCES profiles(id),
              business_name TEXT NOT NULL, contact_name TEXT, email TEXT, phone TEXT, website TEXT,
              city TEXT, state TEXT, category TEXT NOT NULL, description TEXT, notes TEXT,
              is_preferred BOOLEAN DEFAULT false, is_active BOOLEAN DEFAULT true,
              created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()
          );

          CREATE TABLE IF NOT EXISTS organizations (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(), name TEXT NOT NULL, slug TEXT UNIQUE,
              logo_url TEXT, contact_email TEXT, contact_phone TEXT, address TEXT, city TEXT,
              state TEXT, zip TEXT, website TEXT, is_active BOOLEAN DEFAULT true,
              created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()
          );

          CREATE TABLE IF NOT EXISTS realtor_messages (
              id UUID PRIMARY KEY DEFAULT gen_random_uuid(), conversation_id UUID,
              sender_id UUID REFERENCES auth.users(id), recipient_id UUID REFERENCES auth.users(id),
              property_id UUID REFERENCES properties(id), subject TEXT, content TEXT NOT NULL,
              is_read BOOLEAN DEFAULT false, created_at TIMESTAMPTZ DEFAULT NOW()
          );

          -- Enable RLS
          ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
          ALTER TABLE properties ENABLE ROW LEVEL SECURITY;
          ALTER TABLE realtor_customers ENABLE ROW LEVEL SECURITY;
          ALTER TABLE realtor_leads ENABLE ROW LEVEL SECURITY;
          ALTER TABLE saved_properties ENABLE ROW LEVEL SECURITY;
          ALTER TABLE showings ENABLE ROW LEVEL SECURITY;
          ALTER TABLE vendors ENABLE ROW LEVEL SECURITY;
          ALTER TABLE organizations ENABLE ROW LEVEL SECURITY;
          ALTER TABLE realtor_messages ENABLE ROW LEVEL SECURITY;

          -- Service role policies
          DO $$ BEGIN
          CREATE POLICY "service_role_all" ON profiles FOR ALL USING (current_setting('request.jwt.claims', true)::json->>'role' = 'service_role');
          EXCEPTION WHEN duplicate_object THEN NULL; END $$;
          DO $$ BEGIN
          CREATE POLICY "service_role_all" ON properties FOR ALL USING (current_setting('request.jwt.claims', true)::json->>'role' = 'service_role');
          EXCEPTION WHEN duplicate_object THEN NULL; END $$;
          DO $$ BEGIN
          CREATE POLICY "service_role_all" ON realtor_customers FOR ALL USING (current_setting('request.jwt.claims', true)::json->>'role' = 'service_role');
          EXCEPTION WHEN duplicate_object THEN NULL; END $$;
          DO $$ BEGIN
          CREATE POLICY "service_role_all" ON realtor_leads FOR ALL USING (current_setting('request.jwt.claims', true)::json->>'role' = 'service_role');
          EXCEPTION WHEN duplicate_object THEN NULL; END $$;
          DO $$ BEGIN
          CREATE POLICY "service_role_all" ON saved_properties FOR ALL USING (current_setting('request.jwt.claims', true)::json->>'role' = 'service_role');
          EXCEPTION WHEN duplicate_object THEN NULL; END $$;
          DO $$ BEGIN
          CREATE POLICY "service_role_all" ON showings FOR ALL USING (current_setting('request.jwt.claims', true)::json->>'role' = 'service_role');
          EXCEPTION WHEN duplicate_object THEN NULL; END $$;
          DO $$ BEGIN
          CREATE POLICY "service_role_all" ON vendors FOR ALL USING (current_setting('request.jwt.claims', true)::json->>'role' = 'service_role');
          EXCEPTION WHEN duplicate_object THEN NULL; END $$;
          DO $$ BEGIN
          CREATE POLICY "service_role_all" ON organizations FOR ALL USING (current_setting('request.jwt.claims', true)::json->>'role' = 'service_role');
          EXCEPTION WHEN duplicate_object THEN NULL; END $$;
          DO $$ BEGIN
          CREATE POLICY "service_role_all" ON realtor_messages FOR ALL USING (current_setting('request.jwt.claims', true)::json->>'role' = 'service_role');
          EXCEPTION WHEN duplicate_object THEN NULL; END $$;

          -- Public read policies
          DO $$ BEGIN CREATE POLICY "public_read" ON profiles FOR SELECT USING (true); EXCEPTION WHEN duplicate_object THEN NULL; END $$;
          DO $$ BEGIN CREATE POLICY "public_read" ON properties FOR SELECT USING (true); EXCEPTION WHEN duplicate_object THEN NULL; END $$;

          -- User self-management
          DO $$ BEGIN CREATE POLICY "own_update" ON profiles FOR UPDATE USING (auth.uid() = id); EXCEPTION WHEN duplicate_object THEN NULL; END $$;
          DO $$ BEGIN CREATE POLICY "own_insert" ON profiles FOR INSERT WITH CHECK (auth.uid() = id); EXCEPTION WHEN duplicate_object THEN NULL; END $$;

          -- Indexes
          CREATE INDEX IF NOT EXISTS idx_profiles_email ON profiles(email);
          CREATE INDEX IF NOT EXISTS idx_properties_status ON properties(status);
          CREATE INDEX IF NOT EXISTS idx_properties_agent ON properties(agent_id);
          CREATE INDEX IF NOT EXISTS idx_leads_agent ON realtor_leads(agent_id);
          CREATE INDEX IF NOT EXISTS idx_vendors_agent ON vendors(agent_id);

          -- Auto-update trigger
          CREATE OR REPLACE FUNCTION update_updated_at_column() RETURNS TRIGGER AS $$
          BEGIN NEW.updated_at = NOW(); RETURN NEW; END; $$ LANGUAGE plpgsql;

          DROP TRIGGER IF EXISTS update_profiles_updated_at ON profiles;
          CREATE TRIGGER update_profiles_updated_at BEFORE UPDATE ON profiles FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
          DROP TRIGGER IF EXISTS update_properties_updated_at ON properties;
          CREATE TRIGGER update_properties_updated_at BEFORE UPDATE ON properties FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

          -- Auto-create profile on signup
          CREATE OR REPLACE FUNCTION public.handle_new_user() RETURNS TRIGGER AS $$
          BEGIN
              INSERT INTO public.profiles (id, email, full_name, role)
              VALUES (NEW.id, NEW.email, COALESCE(NEW.raw_user_meta_data->>'full_name', ''), 'client')
              ON CONFLICT (id) DO NOTHING;
              RETURN NEW;
          END; $$ LANGUAGE plpgsql SECURITY DEFINER;

          DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
          CREATE TRIGGER on_auth_user_created AFTER INSERT ON auth.users FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

          -- Seed existing users
          INSERT INTO profiles (id, email, full_name, role)
          SELECT id, email, COALESCE(raw_user_meta_data->>'full_name', ''),
              CASE WHEN email LIKE '%tony%' OR email LIKE '%laura%' THEN 'realtor' ELSE 'client' END
          FROM auth.users ON CONFLICT (id) DO UPDATE SET role = 
              CASE WHEN EXCLUDED.email LIKE '%tony%' OR EXCLUDED.email LIKE '%laura%' THEN 'realtor' ELSE profiles.role END;

          SELECT 'Migration complete!' as status, COUNT(*) as profiles_created FROM profiles;
          ENDSQL
          
      - name: Verify Tables
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          psql "postgresql://postgres:$PGPASSWORD@db.kteobfyferrukqeolofj.supabase.co:5432/postgres" -c "
            SELECT table_name FROM information_schema.tables 
            WHERE table_schema = 'public' 
            AND table_name IN ('profiles', 'properties', 'realtor_customers', 'realtor_leads', 
                               'saved_properties', 'showings', 'vendors', 'organizations', 'realtor_messages')
            ORDER BY table_name;
          "
