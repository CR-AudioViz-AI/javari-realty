name: Database Migration

on:
  workflow_dispatch:
    inputs:
      action:
        description: Type MIGRATE to confirm
        required: true

jobs:
  migrate:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'MIGRATE'
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install pg
        run: npm install pg
        
      - name: Run Migration
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          node -e "
          const { Client } = require('pg');
          
          const client = new Client({
            host: 'db.kteobfyferrukqeolofj.supabase.co',
            port: 5432,
            user: 'postgres',
            password: process.env.PGPASSWORD,
            database: 'postgres',
            ssl: { rejectUnauthorized: false }
          });

          async function run() {
            console.log('Connecting...');
            await client.connect();
            console.log('Connected!');
            
            const sql = \`
              CREATE TABLE IF NOT EXISTS profiles (
                id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
                email TEXT UNIQUE NOT NULL,
                full_name TEXT,
                role TEXT DEFAULT 'client',
                created_at TIMESTAMPTZ DEFAULT NOW(),
                updated_at TIMESTAMPTZ DEFAULT NOW()
              );
              
              CREATE TABLE IF NOT EXISTS properties (
                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                agent_id UUID REFERENCES profiles(id),
                title TEXT NOT NULL,
                address TEXT NOT NULL,
                city TEXT NOT NULL,
                state TEXT NOT NULL,
                zip_code TEXT NOT NULL,
                price NUMERIC(12, 2) NOT NULL,
                bedrooms INTEGER,
                bathrooms NUMERIC(3, 1),
                status TEXT DEFAULT 'active',
                created_at TIMESTAMPTZ DEFAULT NOW()
              );
              
              ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
              ALTER TABLE properties ENABLE ROW LEVEL SECURITY;
              
              CREATE POLICY IF NOT EXISTS profiles_read ON profiles FOR SELECT USING (true);
              CREATE POLICY IF NOT EXISTS properties_read ON properties FOR SELECT USING (true);
            \`;
            
            await client.query(sql);
            console.log('Migration done!');
            
            const result = await client.query('SELECT COUNT(*) FROM profiles');
            console.log('Profiles:', result.rows[0].count);
            
            await client.end();
          }
          
          run().catch(e => { console.error(e.message); process.exit(1); });
          "
